{
  "hash": "026e0ee729a6e3a65271d26e4c04f742",
  "result": {
    "markdown": "---\ntitle: \"Synthetic Control: Role of rescaling\"\ndescription: \"I discuss the role of variable transformations on the use of Synthetic control for Causal Analysis\"\nauthor: \"Fernando Rios-Avila\"\ndate: \"5/9/2023\"\ncategories: \n    - Stata\n    - Programming\n    - Causal effects\ndraft: false\n---\n\n## Introduction\n\nAs a wise man once said:\n\n> **The best way to learn something is to teach it.** \n\nNot sure who said that, but I find it to be true, except for instances when the learning process puts you in a position where you have a question, but you do not know how to find an answer. This is one of those ocasions.\n\nAs some of you may know, the technique known as **Synthetic Control** is a widely recognized methodology used to determine the effects of a treatment on a single treated entity. It accomplishes this by identifying the optimal combination of control variables that form a synthetic control.\n\nThe purpose of this SControl is to provide an answer to the question of \"What would have happened to the treated group **if** no treatment had been administered?\" \n\nHowever, when dealing with a single unit of interest, there is a risk of mistaking random fluctuations with the actual treatment effect. To mitigate this risk one may run a set of placebo tests. One of them involves estimating pseudo treatment effects for each individual \"control\" unit. Ideally, if the controls were adequate, there should be no discernible effect among them. If the impact on the treated group is significant or unusual enough, we could conclude that there is an effect beyond random chance or noise.\n\nBecause the optimal weights are such you can only construct synthetic controls via interpolation, rather than extrapolation, the estimation of synthetic controls for some of the non-treated units can be difficult. *Unique* units may serve well as controls, but are not suitable as *treated* unit, because no interpolation of data can simulate those units. Because of this, its recommended that one excludes those units when analyzing the significance of the treatment effect.\n\n## How does SC works?\n\nThe basic implementation of SC involves finding a set of optimal weights $w$ such that:\n\n$$\nw^*=\\min_w \\sum_{h} \\left(X_{1,h}-\\sum_{j=2}^J w_j X_{j,h}\\right)^2\n$$\n\nwhere $X's$ is a set of pre-treatment characteristics we would like to equalize between the treated unit and the control units. $X$ can contain pretreament outcome characteristics.  We also require $\\sum w_j =1$ and $w_j\\geq 0$. \n\nOnce the weights have been estimated, we can estimate the treatment effect at any point in time simply as:\n\n$$ \\tau_t = Y_{1,t}-\\sum_{j=2}^J w^*_j \\times Y_{j,t}\n$$\n\n## The question without an answer\n\nSomething that seems interesting to me is that the construction of treatment effects, or estimation of optimal weights say nothing about how should data be used, nor which variation should we be interested in.\n\nGranted, standard approach is to just use data asis, but that seems unsatisfactory. Consider, for example, a case when the interest is on analyzing the effect on GDP of a country level policy in the US. The US being one of the largest economies in the world, it would be difficult, if not impossible to, ex ante, find good controls.\n\nBut what if we change the measure of interest? and look into GDP percapita, or GDP relative levels, or something else. \nAfter the estimation is done, we could certainly reconstruct the original question. \n\nImplementing these kind of transformations would help finding better controls, but could have important impacts when estimating the placebo tests assessing the significance of the estimated effect. Here the question:\n\n> **To what extend can we transform our explanatory variables when implementing SC**\n> **Would the transformations need to be the same for all units? or panel units?**\n\nBelow, I show an example of what could happen when we make these decisions:\n\n## Smoking in California\n\nFor the example I have in mind, I will use the **`Smoking`** dataset that is typically used to teach the methodology. I will also use two community-contributed programs `synth` and `frause`. The second one, just to make it easy uploading the data. \n\nI will also use a small programm to prepare the data before creating the figures. This one is rather long, but if you are interested, please take a look.\n\n::: {.cell execution_count=1}\n``` {.stata .cell-code code-fold=\"true\"}\nset scheme white2\ncapture program drop sc_doer\nprogram sc_doer\n** Estimates the Effect for California.\n    tempfile sc3\n    synth cigsale cigsale(1971) cigsale(1975) cigsale(1980)   cigsale(1985), trunit(3) trperiod(1989) keep(`sc3') replace  \n** And all other states\n    forvalues i =1/39{\n        if `i'!=3 {\n            local pool\n            foreach j of local stl {\n                if `j'!=3 & `j'!=`i' local pool `pool' `j'\n            }\n            tempfile sc`i'\n            synth cigsale cigsale(1971) cigsale(1975) cigsale(1980) cigsale(1985) , ///\n            trunit(`i') trperiod(1989) keep(`sc`i'') replace counit(`pool')\n        }\n    }\n** Collects the Saved files to estimate the Treatment effect\n** and the p-value/ratio statistic\n\n    forvalues i =1/39{\n        use `sc`i'' , clear\n        gen tef`i' = _Y_treated - _Y_synthetic\n        egen sef`i'a =mean( (_Y_treated - _Y_synthetic)^2) if _time<=1988\n        egen sef`i'b =mean( (_Y_treated - _Y_synthetic)^2) if _time>1988\n        gen sef`i'aa=sqrt(sef`i'a[2])\n        gen sef`i'bb=sqrt(sef`i'b[_N])\n\t\treplace sef`i'a=sef`i'aa\n\t\treplace sef`i'b=sef`i'bb\n        drop if _time==.\n        keep tef`i' sef`i'* _time\n        save `sc`i'', replace\n    }\n\n    clear\n    use `sc1'\n    forvalues i = 2/39 {\n        merge 1:1 _time using `sc`i'', nogen\n    }\n    global toplot\n    global toplot2\n** Stores which models will be saved for plotting    \n    forvalues i = 1/39 {\n        global toplot $toplot (line tef`i' _time, color(gs11) )\n    if (sef`i'a[1])<(2*sef3a[1]) {\n            global toplot2 $toplot2 (line tef`i' _time, color(gs11) )\n        }\n    }\n** Estimates the post/pre RMSE ratio\n    capture matrix drop rt\n    forvalues i = 1/39 {\n        if (sef`i'a[1])<(2*sef3a[1]) {\n            matrix rt=nullmat(rt)\\[`i',sef`i'b[1]/sef`i'a[1]]\n        }\n    }\n    svmat rt\n    egen rnk=rank(rt2)\n** and the ranking /p-value for each period\n    gen rnk2=0\n    forvalues i = 1/39 {\n        if   (sef`i'a[1])<(2*sef3a[1]) {\n            local t = `t'+1\n            replace rnk2=rnk2+(tef`i'<=tef3)\t\n        }\n    } \n    gen pv=rnk2*100/`t'\nend\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<style>div.jp-Notebook .datagrid-container {min-height: 448px; }</style>\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\n```\n:::\n:::\n\n\n### ASIS case\n\nThe first case will be the \"vanilla\" one. I will only use 4 pretreatment outcomes for the weight construction: 1971, 1975, 1980 and 1985. The outcome of interest is cigarette sale per capita (in packs). Thus, to some extend, data has already been standardized to be measured in comparable units.\n\nThe basic code will look like this:\n\n```stata\nsynth cigsale cigsale(1971) cigsale(1975) cigsale(1980)   cigsale(1985), trunit(3) trperiod(1989) \n```\n\n::: {.cell execution_count=2}\n``` {.stata .cell-code}\nqui:frause smoking2, clear\nqui:xtset state year\nqui:sort state year\nqui:sc_doer\n```\n:::\n\n\nwhich will produce the following:\n\n::: {#fig-sc1 .cell .column-page layout-ncol='2' layout-nrow='2' execution_count=3}\n``` {.stata .cell-code}\ntwo $toplot (line tef3 _time, lw(1) color(navy*.8)), xline(1989) legend(off) name(m1, replace)\n\ntwo $toplot2 (line tef3 _time, lw(1) color(navy*.8)), xline(1989) legend(off) name(m2, replace)\n\ntwo bar rt2 rnk || bar rt2 rnk if rt1==3 , legend(order( 2 \"California\")) name(m3, replace)\n\ntwo bar pv _time if _time>1988 & pv<40, legend(off) name(m4, replace) ylabel(0(5)25)\n```\n\n::: {.cell-output .cell-output-display}\n![Unrestricted effect](index_files/figure-html/fig-sc1-output-1.png){#fig-sc1-1}\n:::\n\n::: {.cell-output .cell-output-display}\n![Restricted effect](index_files/figure-html/fig-sc1-output-2.png){#fig-sc1-2}\n:::\n\n::: {.cell-output .cell-output-display}\n![RMSE Ratio](index_files/figure-html/fig-sc1-output-3.png){#fig-sc1-3}\n:::\n\n::: {.cell-output .cell-output-display}\n![P-value](index_files/figure-html/fig-sc1-output-4.png){#fig-sc1-4}\n:::\n\nSynthetic Control Results: ASIS\n:::\n\n\nBased on @fig-sc1, there is an effect of the Policy which reduced sales of cigarates. @fig-sc1-3 and @fig-sc1-4 suggest the effect is significant across most post-treatment periods.\n\n### Log Case\n\nLets make one change. Instead of using cigarette sale per capita, I will use the log of that variable. The idea is that while raw data may not be comparable, because of different scales across units, data may be more comparable if its comparessed using a logScale.\n\n\n\n::: {#fig-sc2 .cell .column-page layout-ncol='2' layout-nrow='2' execution_count=5}\n``` {.stata .cell-code}\ntwo $toplot (line tef3 _time, lw(1) color(navy*.8)), xline(1989) legend(off) name(m1, replace)\n\ntwo $toplot2 (line tef3 _time, lw(1) color(navy*.8)), xline(1989) legend(off) name(m2, replace)\n\ntwo bar rt2 rnk || bar rt2 rnk if rt1==3 , legend(order( 2 \"California\")) name(m3, replace)\n\ntwo bar pv _time if _time>1988 & pv<40, legend(off) name(m4, replace) ylabel(0(5)25)\n```\n\n::: {.cell-output .cell-output-display}\n![Unrestricted effect](index_files/figure-html/fig-sc2-output-1.png){#fig-sc2-1}\n:::\n\n::: {.cell-output .cell-output-display}\n![Restricted effect](index_files/figure-html/fig-sc2-output-2.png){#fig-sc2-2}\n:::\n\n::: {.cell-output .cell-output-display}\n![RMSE Ratio](index_files/figure-html/fig-sc2-output-3.png){#fig-sc2-3}\n:::\n\n::: {.cell-output .cell-output-display}\n![P-value](index_files/figure-html/fig-sc2-output-4.png){#fig-sc2-4}\n:::\n\nSynthetic Control Results: Logs\n:::\n\n\nInterestingly enough @fig-sc2 shows a very similar effect plot as in @fig-sc1. The RMSE ratio is even better, but with few post-treatment effects that are not as significant.\n\n### Relative Change\n\nThe next alternative is to use a relative rescaling. Specifically, I will change the baseline of cigsales across all States, so that Cigarette Sales in 1970 is normalized to be 100. The changes, then could be interpreted in units relative to what happened in 1970.\n\n\n\n::: {#fig-sc3 .cell .column-page layout-ncol='2' layout-nrow='2' execution_count=7}\n``` {.stata .cell-code}\ntwo $toplot (line tef3 _time, lw(1) color(navy*.8)), xline(1989) legend(off) name(m1, replace)\n\ntwo $toplot2 (line tef3 _time, lw(1) color(navy*.8)), xline(1989) legend(off) name(m2, replace)\n\ntwo bar rt2 rnk || bar rt2 rnk if rt1==3 , legend(order( 2 \"California\")) name(m3, replace)\n\ntwo bar pv _time if _time>1988 & pv<40, legend(off) name(m4, replace) ylabel(0(5)25)\n```\n\n::: {.cell-output .cell-output-display}\n![Unrestricted effect](index_files/figure-html/fig-sc3-output-1.png){#fig-sc3-1}\n:::\n\n::: {.cell-output .cell-output-display}\n![Restricted effect](index_files/figure-html/fig-sc3-output-2.png){#fig-sc3-2}\n:::\n\n::: {.cell-output .cell-output-display}\n![RMSE Ratio](index_files/figure-html/fig-sc3-output-3.png){#fig-sc3-3}\n:::\n\n::: {.cell-output .cell-output-display}\n![P-value](index_files/figure-html/fig-sc3-output-4.png){#fig-sc3-4}\n:::\n\nSynthetic Control Results: Logs\n:::\n\n\nBased on @fig-sc3, we still have many states with very bad model fitness. @fig-sc3-3 and @fig-sc3-4, however, still shows good model performance, with slighly higher significance than when the data was used as is.\n\n### Fully Rescale (to California pre-treament)\n\nThe last transformation I implement is one where all data is rescaled and shifted so that all countries have the same average and standard deviation in the period before treatment. I believe this could be the best approach, because forces all data to be perfectly comparable in the pre-treatment period, increasing the posibility to find good controls even for the other wise extreme states.\n\n\n\n::: {#fig-sc4 .cell .column-page layout-ncol='2' layout-nrow='2' execution_count=9}\n``` {.stata .cell-code}\ntwo $toplot (line tef3 _time, lw(1) color(navy*.8)), xline(1989) legend(off) name(m1, replace)\n\ntwo $toplot2 (line tef3 _time, lw(1) color(navy*.8)), xline(1989) legend(off) name(m2, replace)\n\ntwo bar rt2 rnk || bar rt2 rnk if rt1==3 , legend(order( 2 \"California\")) name(m3, replace)\n\ntwo bar pv _time if _time>1988 & pv<40, legend(off) name(m4, replace) ylabel(0(5)25)\nframe put *, into(m4)\n```\n\n::: {.cell-output .cell-output-display}\n![Unrestricted effect](index_files/figure-html/fig-sc4-output-1.png){#fig-sc4-1}\n:::\n\n::: {.cell-output .cell-output-display}\n![Restricted effect](index_files/figure-html/fig-sc4-output-2.png){#fig-sc4-2}\n:::\n\n::: {.cell-output .cell-output-display}\n![RMSE Ratio](index_files/figure-html/fig-sc4-output-3.png){#fig-sc4-3}\n:::\n\n::: {.cell-output .cell-output-display}\n![P-value](index_files/figure-html/fig-sc4-output-4.png){#fig-sc4-4}\n:::\n\nSynthetic Control Results: Rescale to California\n:::\n\n\nWhat I consider quite interesting is that even the effect plot that uses no restrictions shows very good pre-treatment model fit for all donor units. Although the fitness for California is even better. Once we impose the same restriction to the data, excluding units with a RMSE twice as large as the one in California, we obtain a plot similar to the ones in the previous cases.\n\n@fig-sc4-3 and @fig-sc4-4 show that the effect may not be as strong as in the previous example. The RMSE ratio method suggests a p-value of 12.5%, above the standard 5% we like to consider as minimum threshold. The significance across periods is also slighly worse, because there is one state that exhibits a pseudo treatment that is larger than California. \n\n## Comparing Magnitude effects\n\n::: {.cell execution_count=10}\n``` {.stata .cell-code code-fold=\"true\"}\nqui:frause smoking2, clear\ntempfile sc1x sc2x sc3x sc4x\nxtset state year\nqui: {\n    gen or_cigsale=cigsale\n    synth cigsale cigsale(1971) cigsale(1975) cigsale(1980)   cigsale(1985), trunit(3) trperiod(1989) keep(`sc1x') replace  \n    replace cigsale=log(or_cigsale)\n    synth cigsale cigsale(1971) cigsale(1975) cigsale(1980)   cigsale(1985), trunit(3) trperiod(1989) keep(`sc2x') replace  \n    sort state year\n    by state:replace cigsale=or_cigsale/or_cigsale[1]*100\n    synth cigsale cigsale(1971) cigsale(1975) cigsale(1980)   cigsale(1985), trunit(3) trperiod(1989) keep(`sc3x') replace  \n\n    sum or_cigsale if state==3 & year<=1988\n    local cmean=r(mean)\n    local smean=r(sd)\n    forvalues i = 1/39 {\n        sum or_cigsale if state==`i' & year<=1988\n        replace cigsale = `cmean' + `smean' * (or_cigsale - r(mean))/r(sd) if state==`i'\n    }\n    synth cigsale cigsale(1971) cigsale(1975) cigsale(1980)   cigsale(1985), trunit(3) trperiod(1989) keep(`sc4x') replace  \n}\n\nclear\nuse `sc1x'\nrename  _Y_synthetic y1_synth\ndrop if _time==.\nsave `sc1x', replace\n\nuse `sc2x'\nrename  _Y_synthetic y2_synth\nreplace y2_synth = exp(y2_synth )\ndrop if _time==.\nsave `sc2x', replace\n\nuse `sc3x'\nren _Y_synthetic y3_synth\ndrop if _time==.\nsave `sc3x', replace\n\nuse `sc4x'\nren _Y_synthetic y4_synth\ndrop if _time==.\nsave `sc4x', replace\n\nuse `sc1x', clear\nmerge 1:1 _time using `sc2x', nogen\nmerge 1:1 _time using `sc3x', nogen\nmerge 1:1 _time using `sc4x', nogen\n\nreplace y3_synth=y3_synth* _Y_treated[1]/100\ngen eff1= _Y_treated-y1_synth\ngen eff2= _Y_treated-y2_synth\ngen eff3= _Y_treated-y3_synth\ngen eff4= _Y_treated-y4_synth\n```\n:::\n\n\nPerhaps what would be the best way to comapre the different cases presented above is to rescale the results as to obtain results that can be compared across specifications. In @fig-sc5, I puts together this effects, so that they can be compared across each other. \n\n::: {.cell execution_count=11}\n``` {.stata .cell-code}\nscatter eff* _time, connect(l l l l) msymbol(O D T S) xline(1989) ///\nlegend(order(1 \"Asis  2.550\" 2 \"Logs 2.859\" 3 \"Rate 1.928\" 4 \"Rescaled 1.955\"))\n```\n\n::: {.cell-output .cell-output-display}\n![Synthetic Control Effects](index_files/figure-html/fig-sc5-output-1.png){#fig-sc5}\n:::\n:::\n\n\nInterestingly enough, Model Specification does very little on the estimated effect, as they all suggest a sharp decline in Cigarette sales of just above 10 fewer packs per capita 3 years after implementation, up to 25/27 fewer packs per capita by 2000.  \n\nAsis and Logs specifications show the largest decline in 1997 (30 fewer packs), with rescaled and rate specifications being the most conservative. The table also provides the pre-RMSE for all models. They suggest that using Rates provided the best fit, followed by the ReScaled data, using data as is, and using the log transformation.\n\n## Conclusions\n\nThis was an interesting excercise driven by asking if it matter how the covariates are measured when applying SC. I was also curious about this approach, as I was trying to understand one of the extensions of the methodology: Synthetid Differences in Differences. This may require some testing, but that can be left for a future exploration.\n\nIt may seem, for this simplified example, that it doesnt really matter how covariates are transformed. The estimated effects were effectively the same. This conclusion, however, may not be valid in more complex settings. \n\nPerhaps the only concern at this point is that the \"significance\" level of the estimates did change considerably with the data rescaling approach. Granted, the change seems large, because the sample is small (25 observations), and a single change in ranking may look like a large change in the p-value of the statistic.\n\nIf you are reading this, and have some comments, please let me know. \n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}