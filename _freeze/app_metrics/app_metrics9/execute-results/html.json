{
  "hash": "3ad30d3bea94aca4cd39071075a3f1e7",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Quantile regressions with multiple fixed effects\nsubtitle: A Method of Moments Approach\nauthor:\n  - Fernando Rios-Avila\n  - Gustavo Canavire-Bacarreza\n  - Leonardo Siles\nformat:\n  html:\n    code-fold: true\n    code-overflow: wrap\n    echo: false\n    css: styles.css\n    highlight-style: github\nbibliography: refer.bib\n---\n\n# Introduction\n\n## What do Quantile Regressions do?\n\n- Quantile Regressions are an alternative to standard linear regressions that help us to better understand the relationship between the distribution of $Y$ and $X's$.\n\n- In constrast with Linear regression models, where one focuses on explaining $E(y|X)$ as a function of $X$, quantile regressions aim to assess the relationship between $Q_\\tau(y|X)$ with respect to $X$.\n\n  - This means that to interpret Q-regressions properly, one needs to \"condition\" on $X$ but also on $\\tau$.\n\n- Quantile Regressions are nonlinear-models, that \"look\" and can be interpreted as linear ones.\n \n##\n\n::: {#a8fd98b8 .cell execution_count=1}\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<style>div.jp-Notebook .datagrid-container {min-height: 448px; }</style>\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nNumber of observations (_N) was 0, now 250.\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](app_metrics9_files/figure-html/cell-2-output-3.png){}\n:::\n:::\n\n\n## Estimation \n\n- A Generalization of Quantile regression data generating function can be written as follows:\n\n$$y_i = \\beta_0(\\tau)+\\beta_1(\\tau) X_{i,1}+\\beta_2(\\tau) X_{i,2}+...+\\beta_k(\\tau) X_{i,k}\n$$\n\n- Base on this specification, few characteristics should be considered:\n  \n  1. Slopes $\\beta_k(\\tau)$ will vary across quantiles only if the model is Heteroskedastic.\n  2. Qreg can be considered as a semi-parametric-varying coefficient model, with unobserved running variable ($\\tau$).\n  3. Coefficients are percentile specific, but functional forms can be used for more efficient estimation.\n  4. It is possible to separate location effects (mean) from scale effect (deviation from the mean)\n\n## \n\n**Standard** \n\n$$\\beta(\\tau) \\leftarrow \\frac 1 n \\sum \\left[ I(x_i\\beta(\\tau) \\geq y_i) - \\tau \\right] =0 \n$$\n\n**Semiparamatric** (@kaplan2022)\n\n$$\\beta(\\tau) \\leftarrow \\frac 1 n \\sum \\left[ F\\left(\\frac{x_i\\beta(\\tau)-y_i}{bw} \\right) - \\tau \\right] =0\n$$\n\n**Functional** (@bottai2019)\n\n$$\\beta(\\tau) = \\theta_0 + \\theta_1 \\tau + \\theta_2 \\tau^2 +...\n$$\n\n**Location-Scale**\n$$\\beta(\\tau) = \\beta + \\gamma(\\tau)\n$$\n\n## \n\n\n\n:::{.panel-tabset}\n\n## qreg\n\n![](fig91.png){heigth=100% fig-align=center}\n\n## sivqr\n\n![](fig92.png){heigth=100% fig-align=center}\n\n## Location-Scale\n\n![](fig93.png){heigth=100% fig-align=center}\n\n:::\n\n# The Problem\n\n## How to account for  fixed effects?\n\n- As said before, quantile regresions are nonlinear models. Thus, one cannot just add Dummies to address group fixed effects\n\n$$Q_\\tau(y|x) = \\beta_0(\\tau) + \\beta_1 X(\\tau) + \\sum \\delta(\\tau)_g\n$$\n\nThis creates an  incidental parameter problem. Neither $\\delta(\\tau)'s$ nor $\\beta's$ would be consistently estimated.\n\n- But then how to solve it?\n\n## Some Solutions \n\n**@koenker2004**: Assume Fixed effects only have an impact on Location, and Shrink invidual effects (LASSO)\n$$y_i = \\beta(\\tau)X + \\delta_g \n$$\n\n**@canay2011**: Similar to @koenker2004, but \"eliminate them\" before running Qreg\n\n$$\\begin{aligned}\ny = \\beta X + \\delta_g + e \\\\\nQ_\\tau(y - \\delta_g|X) = \\beta(\\tau)X \n\\end{aligned}\n$$\n\n**@Abrevaya2008**: Correlated Random effects Model\n$$Q_\\tau(y|X) = \\beta(\\tau)X + \\gamma(\\tau) E(X|g)$$\n\n## @mss2019\n\n- This method was developed  (and implemented using `xtqreg`) to incorporate individual fixed effects (Useful when considering panel data)\n\n- In principle its an extension of @he2019, who proposed an strategy to estimate Qreg coefficients using a restricted location-scale model, assuming the following structure:\n$$y_i = X_i\\beta + \\varepsilon X_i\\gamma\n$$\n\nThus, Quantile regression model is given by:\n\n$$Q_\\tau(y|X)=X\\left(\\beta + F^{-1}_\\varepsilon(\\tau) \\gamma \\right) = X \\beta(\\tau)\n$$\n\n- Instead of requiring $K\\times M$ coefficients to identify the whole conditional distribution, it only requires $2\\times K + M$.\n  \n- Also, Quantile curves will not cross!\n\n## How does Simplified @he2019 and @mss2019 works?\n$$y_i = x_i \\beta + \\varepsilon x_i \\gamma \\rightarrow Q_\\tau(y|X)=X\\beta + X\\gamma F_\\varepsilon^{-1}(\\tau)\n$$\n\n#### Step 1: Location model $E(X'(y-X\\beta))=0$\n\n#### Step 2: Scale model $E(X'(|y-X\\beta|-X\\gamma))=0$\n\n#### Step 3: Standardized Quantile $E\\left[ I\\left( \\frac{y-X\\beta}{X\\gamma} \\geq q_\\tau \\right) -\\tau  \\right]=0$\n\n#### Step 4: Aggregate $\\beta(\\tau) = \\beta + q_\\tau \\gamma$\n\n## Extension: Multiple Fixed effects \n\n@mss2019 propose an extension: To add a single set of fixed effect (panel) apply Frisch–Waugh–Lovell theorem.\n\nThis can be extended to controlling for multiple fixed effects:\n\n$$\\tilde w_i = w_i +\\bar w - \\delta^w_{g1} - \\delta^w_{g2} - ... - \\delta^w_{gk} \\ \\forall \\  w \\in y,x\n$$\n\nAnd use almost the same moments as before:\n\n$$\\begin{aligned}\n E(\\tilde X(\\tilde y-\\tilde X\\beta)) & =0 \\\\\n E(\\tilde X(|\\tilde y- \\tilde X\\beta|-\\tilde X\\gamma)) &=0 \\\\\n X\\gamma + \\delta's &= y - (\\tilde y- \\tilde X\\gamma) \\\\\n E\\left[ I\\left( \\frac{\\tilde y- \\tilde X\\beta}{X\\gamma+ \\delta's } \\geq q_\\tau \\right) -\\tau  \\right] &=0\n\\end{aligned}\n$$\n\n## Extension: Standard Errors\n\n- Along with the modified algorithm that allows for Panel Fixed effects, @mss2019 proposed a GLS type variance estimator.\n\n  - The model assumes the existance of Heteroskedasticity.\n  - Based on Law of Iterated Expectations, and assuming Heteroskedasticity is correctly specified, its possible to construct a GLS type Variance Estimator. \n\n- How does this work? \n\n## Location Model\n\n- Consider the location model: $y_i = x_i \\beta +  \\varepsilon_i x_i \\gamma$\n- Which has known heteroskedasticity: $Var(y_i - x_i\\beta)=(x_i\\gamma)^2 \\sigma^2_\\varepsilon$\n\n- @mss2019 GLS Variance would be:\n$$\\begin{aligned}\ne &= y_i - X\\beta = \\varepsilon_i x_i \\gamma\\\\\nVar(\\hat\\beta) &= (X'X)^{-1}\\sum x_i x_i' \\color{red}{e_i^2} (X'X)^{-1} \\\\\n&=\\color{red}{\\sigma_\\varepsilon^2} (X'X)^{-1} \\sum x_i x_i' \\color{red}{(x_i'\\gamma)^2} (X'X)^{-1}\n\\end{aligned}\n$$\n\nHowever, this can be sensitive to the modeling of the Scale function.\n\nBut one can almost always Bootstrap...\n\n## Extension: Robust and Clustered SE\n\nAn extension offered in my implementation makes full use of the moment conditions, and the implicit  Influence functions:\n$$\\begin{aligned}\nIF'_{i,\\beta} &= N(X'X)^{-1} x_i R_i    \\\\\nIF'_{i,\\gamma} &= N(X'X)^{-1} x_i \\Big( \\tilde R_i  -x_i'\\gamma \\Big) \\\\\n\\color{blue}{IF_{i, q(\\tau)}} &= \\frac{\\tau -I(q_\\tau \\geq \\varepsilon_i) }{f_\\varepsilon(q_\\tau)} \n- \\frac{R_i}{\\bar x'\\gamma} \n- q_\\tau \\frac{\\tilde R_i -x_i'\\gamma}{\\bar x'\\gamma}\\\\\nR_i &= y_i-x_i'\\beta \\\\\n\\tilde R_i & =2 R_i \\big[1(R_i \\geq 0) - E(1(R_i \\geq 0)) \\big]\n\\end{aligned}\n$$\n\nSo we just stack Influence functions to obtain Robust and Clustered Standard errors:\n\n## \n\nRobust SE\n$$Var_r(\\beta,\\gamma,q_\\tau) = \\frac{1}{N^2}\n\\left[ \\begin{matrix}\nIF_\\beta & IF_\\gamma & IF_{q_\\tau}\n\\end{matrix}\n\\right]'\\left[ \\begin{matrix}\nIF_\\beta & IF_\\gamma & IF_{q_\\tau}\n\\end{matrix}\n\\right]\n$$\n\nCluster SE\n\n$$Var_c(\\beta,\\gamma,q_\\tau) = \\frac{1}{N^2}\n\\left[ \\begin{matrix}\nSIF_\\beta & SIF_\\gamma & SIF_{q_\\tau}\n\\end{matrix}\n\\right]'\\left[ \\begin{matrix}\nSIF_\\beta & SIF_\\gamma & SIF_{q_\\tau}\n\\end{matrix}\n\\right]\n$$\n$$SIF_{w} = \\left[ \\begin{matrix}\nSIF_{g=1,w} \\\\\nSIF_{g=2,w}  \\\\ ... \\\\\\\nSIF_{g=G,w}  \n\\end{matrix}\\right] \\& SIF_{g=k, \\ w} = \\sum_{i \\in g=k} IF_{i,w}\n$$\n\nEasily allows for simultaneous Qregressions and weights\n\n## Command syntax `mmqreg` \n\n```markdown\nmmqreg depvar indepvar [if in] [pw] , [Options] <-- Standard Syntax\n\n** Variance Options\n   Default: MSS(2019) GLS SE\n  -robust-: Robust Standard errors, no DOF Correction (GMM)\n  -cluster(varname)-: Clustered Standard errors, no DOF Correction (GMM)\n  -dfadj-: Simple Adjustment (n-k-1)\n\n** Output\n  - q(numlist): List of Quantiles to be estimated (default q=50)\n  - ls        : Request Providing Location Scale coefficient models\n```\n\nThere will be some differences with `xtqreg` because of couple of differences in the math and programming.\n\n## Example {.scrollable}\n\n::: {#276ce91d .cell .larger execution_count=3}\n``` {.stata .cell-code .code-overflow-wrap code-fold=\"false\"}\nwebuse nlswork, clear\nqui:mmqreg ln_w age ttl_exp tenure not_smsa south, ///\n    abs(idcode) \nest sto m1\nqui:mmqreg ln_w age ttl_exp tenure not_smsa south, ///\n    abs(idcode) robust\nest sto m2\nqui:mmqreg ln_w age ttl_exp tenure not_smsa south, ///\n    abs(idcode) cluster(idcode)\nest sto m3\nqui:mmqreg ln_w ttl_exp tenure not_smsa south, ///\n    abs(idcode age) cluster(idcode)\nest sto m4\nesttab m1 m2 m3 m4, se  nomtitle nogap \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(National Longitudinal Survey of Young Women, 14-24 years old in 1968)\n\n----------------------------------------------------------------------------\n                      (1)             (2)             (3)             (4)   \n----------------------------------------------------------------------------\nqtile                                                                       \nage              -0.00270**      -0.00270**      -0.00270*                  \n               (0.000868)      (0.000890)       (0.00127)                   \nttl_exp            0.0292***       0.0292***       0.0292***       0.0341***\n                (0.00178)       (0.00153)       (0.00225)       (0.00229)   \ntenure             0.0108***       0.0108***       0.0108***       0.0102***\n                (0.00191)      (0.000989)       (0.00145)       (0.00144)   \nnot_smsa          -0.0925***      -0.0925***      -0.0925***      -0.0880***\n                (0.00974)        (0.0104)        (0.0140)        (0.0138)   \nsouth             -0.0640***      -0.0640***      -0.0640***      -0.0599***\n                 (0.0116)        (0.0121)        (0.0167)        (0.0167)   \n_cons               1.611***        1.611***        1.611***        1.490***\n                 (0.0564)        (0.0194)        (0.0276)        (0.0146)   \n----------------------------------------------------------------------------\nN                   28093           28093           28093           28093   \n----------------------------------------------------------------------------\nStandard errors in parentheses\n* p<0.05, ** p<0.01, *** p<0.001\n```\n:::\n:::\n\n\n## {.scrollable}\n\n::: {#bd87c547 .cell .larger execution_count=4}\n``` {.stata .cell-code .code-overflow-wrap code-fold=\"false\"}\nsysuse auto, clear\nqui:mmqreg price mpg trunk  , \nest sto m1\nqui:mmqreg price mpg trunk  , robust\nest sto m2\nqui:bootstrap, reps(250):mmqreg price mpg trunk\nest sto m3\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(1978 automobile data)\n```\n:::\n:::\n\n\n::: {#e9e12dfa .cell .larger execution_count=5}\n\n::: {.cell-output .cell-output-stdout}\n```\n\n------------------------------------------------------------\n                      (1)             (2)             (3)   \n                  default          Robust       Bootstrap   \n------------------------------------------------------------\nqtile                                                       \nmpg                -172.7          -172.7***       -172.7*  \n                (38416.1)         (44.85)         (71.63)   \ntrunk               33.67           33.67           33.67   \n                (50437.7)         (49.04)         (56.11)   \n_cons              8457.3          8457.3***       8457.3***\n              (1454004.1)        (1617.9)        (2303.5)   \n------------------------------------------------------------\nN                      74              74              74   \n------------------------------------------------------------\nStandard errors in parentheses\n* p<0.05, ** p<0.01, *** p<0.001\n```\n:::\n:::\n\n\n## Plotting: qreg vs mmqreg\n\n\n\n:::{.panel-tabset}\n\n## `qreg`\n\n![](fig94.png)\n\n## `mmqreg`\n\n![](fig95.png)\n\n:::\n\n## Conclusions\n\n- In this presentation I present a quick review of quantile regressions, with emphasis on solutions for adding fixed effects.\n\n- The Location and Scale model help with the problem because it reduces the number of coefficients to needed to be estimated for consistent estimates. \n  - In MSS2019, inconsistencies are still observed with Small T. (get long data)\n  - In my context, this may be less biding, because is more likely to have many obs per Fixed characteristic. \n\n- While the model may be restrictive (multiplicative heteroskedasticity) it may still be useful for exploration, and analysis when other methodologies are not feasible. \n\n## References \n\n::: {#refs}\n:::\n\n# Extra: Correlated Random Effects Model\n\n## Short intro\n\n- Correlated Random Effects model can also be applied for the estimation of Q-regressions with large set of fixed effects.\n  - In Linear models, point estimates are identical to panel FE (or Dummy inclusion appraoch)\n- Estimating Standard errors, however, can be tricky.\n  - If only 1 set of FE is used, clustered SE by the Fixed effects will give identical results.\n    But equivalances dissapear with 2 or more sets of fixed effects\n- May not work with **Qreg** if FE are not a function of conditional means of all other explanatory variables. (compound error will not be related to $\\tau$ of the original ranking)\n- But may still be a good approximation !\n\n## `cre`: For Correlated Random Effects Model\n\n```markdown\nfrom -fra install-\nsyntax: \n  cre, abs(varlist) [keep compact]: [regression command]\n- a prefix command. Gathers all controls and obtains conditional means\n  based on FE groups\n- Adds them to model specification, and estimates the model.\n- SE should be accounted for in the command.\n\n** Example\ncre, abs(idcode):qreg ln_w age ttl_exp tenure not_smsa south, ///\n    cluster(idcode)\n```\n\n## Comparing Methods {.scrollable}\n\n::: {#57009c06 .cell execution_count=7}\n``` {.stata .cell-code code-fold=\"true\"}\nclear\nset seed 101\nset obs 5000\ngen g = runiformint(1,250)\ngen rnd1 = rchi2(4)/4\ngen rnd2 = rchi2(4)/4\ngen rnd3 = rchi2(4)/4 - 1\n\nbysort g:gen fe = rnd1[1]\nbysort g:gen fe2 = rnd1[2] + fe\nbysort g:gen x1  =2 - fe + rchi2(4)/4\nbysort g:gen x2  = fe + rnd2[1] \n\ngen tau = runiform()\n\ngen y = 2+ tau + log(tau) + tau^2 * x1 - log(tau) * x2 + 2*tau*fe2\n\nqreg y x1 x2 fe2\nqregplot x1, name(m1, replace) title(Benchmark) graphregion( margin(r=5)) estore(ss)\nest restore ss\nmatrix qq=e(qq)\nmatrix bb=e(bs)\nmatrix ll=e(ll)\nmatrix uu=e(ul)\nsvmat qq\nsvmat bb\nsvmat ll\nsvmat uu\ncre , abs(g) keep: qreg y x1 x2 \nqregplot x1, name(m2, replace) title(CRE) graphregion( margin(r=5))\naddplot : rarea ll1 uu1 qq1, color(%30) lcolor(%0) pstyle(p4) || line bb1 qq1 , color(%40)  pstyle(p4)\n\nmmqreg y x1 x2, abs(g)\nqregplot x1, name(m3, replace) title(mmqreg) graphregion( margin(r=5))\naddplot : rarea ll1 uu1 qq1, color(%30) lcolor(%0) pstyle(p4) || line bb1 qq1 , color(%40)  pstyle(p4)\n \n reghdfe y x1 x2, abs(fex=g)\ngen y2 = y-fex\nqreg y2 x1 x2\nqregplot x1, name(m4, replace) title(Canay2011) graphregion( margin(r=5))\naddplot : rarea ll1 uu1 qq1, color(%30) lcolor(%0) pstyle(p4) || line bb1 qq1 , color(%40)  pstyle(p4)\n\nqreg y x1 x2 fex\nqregplot x1, name(m5, replace) title(M-Canay2011) graphregion( margin(r=5))\naddplot : rarea ll1 uu1 qq1, color(%30) lcolor(%0) pstyle(p4) || line bb1 qq1 , color(%40)  pstyle(p4)\n\nqreg y x1 x2\nqregplot x1, name(m6, replace) title(qreg no FE) graphregion( margin(r=5))\naddplot : rarea ll1 uu1 qq1, color(%30) lcolor(%0) pstyle(p4) || line bb1 qq1 , color(%40)  pstyle(p4)\n\ngraph combine m1 m2 m3 m4 m5 m6, col(3) ycommon nocopies \n\ngraph export fig99.png, width(2000) replace\n```\n:::\n\n\n![](fig99.png){heigth=100% fig-align=center}\n\n# Thank you!\n\n",
    "supporting": [
      "app_metrics9_files\\figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}